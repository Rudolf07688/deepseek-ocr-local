# DeepSeek-OCR Docker Image for macOS
# This is an OPTIONAL alternative for Docker-based development on macOS
# RECOMMENDED: Use native installation (see DEVICE_SUPPORT.md) for better performance
#
# Usage:
#   docker build -f Dockerfile.macos -t deepseek-ocr:macos .
#   docker run --rm -v $(pwd)/input:/app/input -v $(pwd)/output:/app/output \
#     deepseek-ocr:macos python quick_test.py /app/input/sample.pdf

FROM python:3.11-slim

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1

# Install system dependencies
RUN apt-get update && apt-get install -y \
    poppler-utils \
    libgl1-mesa-glx \
    libglib2.0-0 \
    wget \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install uv (Astral's fast Python package installer)
RUN pip3 install --no-cache-dir uv

# Set working directory
WORKDIR /app

# Install PyTorch (CPU version, no CUDA for macOS)
RUN uv pip install --system \
    torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

# Install other dependencies from standard PyPI
RUN uv pip install --system \
    transformers==4.45.0 \
    tokenizers \
    einops \
    addict \
    easydict \
    pillow \
    pdf2image \
    tqdm \
    matplotlib

# Copy application code
COPY deepseek_ocr_pdf.py .
COPY advanced_examples.py .
COPY quick_test.py .
COPY src/ src/

# Create directories
RUN mkdir -p /app/input /app/output /app/models

# Set model cache location
ENV HF_HOME=/app/models
ENV TRANSFORMERS_CACHE=/app/models

# Use uv to run Python with proper environment
CMD ["uv", "run", "python3", "-c", "import torch; print(f'PyTorch: {torch.__version__}'); print(f'MPS Available: {torch.backends.mps.is_available()}')"]
